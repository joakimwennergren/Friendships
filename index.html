<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendships: Multiplayer</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }
        
        h1 {
            color: #4a6fa5;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .multiplayer-area {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 900px) {
            .multiplayer-area {
                grid-template-columns: 1fr;
            }
        }
        
        .player-card {
            background-color: #f9fafc;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e1e5eb;
            transition: all 0.3s;
        }
        
        .player-card.active {
            border-color: #4a6fa5;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        .player-card.you {
            border-color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.05);
        }
        
        .player-name {
            font-weight: bold;
            color: #4a6fa5;
            margin: 0 0 15px 0;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-name.you {
            color: #2ecc71;
        }
        
        .you-badge {
            background-color: #2ecc71;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 25px;
        }
        
        @media (max-width: 750px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }
        
        .friends-panel, .actions-panel, .powers-panel {
            background-color: #f9fafc;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e1e5eb;
        }
        
        .powers-panel {
            grid-column: 1 / -1;
        }
        
        .panel-title {
            color: #4a6fa5;
            border-bottom: 2px solid #e1e5eb;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        .friend {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            cursor: pointer;
            border-left: 4px solid transparent;
            position: relative;
        }
        
        .friend:hover {
            transform: translateY(-3px);
        }
        
        .friend-name {
            font-weight: bold;
            color: #4a6fa5;
            margin: 0 0 5px 0;
        }
        
        .love-language {
            display: inline-block;
            background-color: #e8f4f8;
            color: #2c7a9e;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
            border: 1px solid #b6e0f0;
        }
        
        .friendship-meter {
            height: 10px;
            background-color: #e1e5eb;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .friendship-fill {
            height: 100%;
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s;
        }
        
        .friendship-level {
            font-size: 14px;
            color: #666;
        }
        
        .action-btn, .power-btn, .multiplayer-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .action-btn {
            background-color: #4a6fa5;
            color: white;
        }
        
        .action-btn:hover {
            background-color: #3a5a80;
        }
        
        .action-btn.matching {
            background-color: #2ecc71;
            animation: pulse-green 2s infinite;
        }
        
        .action-btn.mismatching {
            background-color: #e74c3c;
        }
        
        .power-btn {
            background-color: #8a4fa3;
            color: white;
        }
        
        .power-btn:hover {
            background-color: #6a3a80;
        }
        
        .multiplayer-btn {
            background-color: #3498db;
            color: white;
            margin-top: 10px;
        }
        
        .multiplayer-btn:hover {
            background-color: #2980b9;
        }
        
        .multiplayer-btn.disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .action-btn:disabled, .power-btn:disabled, .multiplayer-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .action-cost, .power-cost {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        
        .power-cost {
            color: #8a4fa3;
        }
        
        .matching-bonus {
            display: inline-block;
            background-color: #2ecc71;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .event-log {
            background-color: #f0f4f8;
            border-radius: 10px;
            padding: 15px;
            margin-top: 25px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e1e5eb;
        }
        
        .log-title {
            color: #4a6fa5;
            margin-top: 0;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px dashed #e1e5eb;
        }
        
        .log-entry.system {
            color: #7f8c8d;
            font-style: italic;
        }
        
        .log-entry.player {
            color: #3498db;
        }
        
        .log-entry.you {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            margin-bottom: 25px;
            text-align: center;
            background-color: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            gap: 10px;
        }
        
        @media (max-width: 800px) {
            .stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .stat {
            padding: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a6fa5;
        }
        
        .power-value {
            color: #8a4fa3;
        }
        
        .warning-value {
            color: #e67e22;
        }
        
        .danger-value {
            color: #e74c3c;
        }
        
        .match-value {
            color: #2ecc71;
        }
        
        .multiplayer-value {
            color: #3498db;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
        }
        
        .game-intro {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f0f4f8;
            border-radius: 10px;
            border-left: 4px solid #4a6fa5;
        }
        
        .powers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .power-cooldown {
            font-size: 12px;
            color: #e74c3c;
            margin-top: 3px;
        }
        
        .special-event {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            animation: fadeIn 0.5s;
        }
        
        .special-event h3 {
            margin-top: 0;
            color: #e67e22;
        }
        
        .forgotten-badge {
            display: inline-block;
            background-color: #e74c3c;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }
        
        .love-language-tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            width: 200px;
            z-index: 100;
            display: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #4a6fa5;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .level-1 { background-color: rgba(255, 243, 205, 0.3); }
        .level-2 { background-color: rgba(255, 234, 167, 0.5); }
        .level-3 { background-color: rgba(248, 215, 218, 0.7); }
        
        .love-language-info {
            background-color: #e8f4f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2c7a9e;
        }
        
        .love-language-info h3 {
            color: #2c7a9e;
            margin-top: 0;
        }
        
        .language-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .language-item {
            background-color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 13px;
            border: 1px solid #b6e0f0;
        }
        
        .chat-container {
            background-color: #f0f4f8;
            border-radius: 10px;
            padding: 15px;
            margin-top: 25px;
            border: 1px solid #e1e5eb;
        }
        
        .chat-messages {
            height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e1e5eb;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .chat-input button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .invite-section {
            background-color: #e8f4f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .invite-code {
            font-size: 24px;
            font-weight: bold;
            color: #2c7a9e;
            letter-spacing: 2px;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            display: inline-block;
            border: 2px dashed #2c7a9e;
        }
        
        .player-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .player-status.online {
            color: #2ecc71;
        }
        
        .player-status.offline {
            color: #e74c3c;
        }
        
        .turn-indicator {
            background-color: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Friendships: Multiplayer</h1>
        <div class="subtitle">Spela med vänner - bygg vänskaper tillsammans!</div>
        
        <div id="lobby-screen">
            <div class="game-intro">
                <h2>Välkommen till Friendships Multiplayer!</h2>
                <p>Skapa ett spel eller gå med i ett med en inbjudningskod. Ni spelar på samma vänner men var och en har egna resurser och kan hjälpa varandra med superkrafter!</p>
            </div>
            
            <div class="invite-section">
                <h3>Skapa ett nytt spel</h3>
                <button id="create-game-btn" class="multiplayer-btn">Skapa nytt spel</button>
                
                <div id="game-created-section" style="display: none; margin-top: 20px;">
                    <h4>Ditt spel är skapat!</h4>
                    <p>Dela den här koden med dina vänner:</p>
                    <div class="invite-code" id="invite-code-display">LADDAR...</div>
                    <p>Väntar på spelare...</p>
                    <button id="start-game-btn" class="multiplayer-btn disabled" disabled>Starta spel (minst 2 spelare)</button>
                </div>
            </div>
            
            <div class="invite-section">
                <h3>Gå med i ett spel</h3>
                <input type="text" id="join-code-input" placeholder="Ange inbjudningskod" style="width: 200px; padding: 10px; margin-right: 10px;">
                <button id="join-game-btn" class="multiplayer-btn">Gå med</button>
                <div id="joining-status" style="margin-top: 10px;"></div>
            </div>
            
            <div id="player-name-section" style="display: none; margin-top: 20px;">
                <h3>Välj ditt namn</h3>
                <input type="text" id="player-name-input" placeholder="Ditt namn" style="width: 200px; padding: 10px; margin-right: 10px;">
                <button id="confirm-name-btn" class="multiplayer-btn">Bekräfta namn</button>
            </div>
        </div>
        
        <div id="game-screen" style="display: none;">
            <div class="multiplayer-area" id="players-container">
                <!-- Spelare läggs till här dynamiskt -->
            </div>
            
            <div class="love-language-info">
                <h3>De fem kärleksspråken:</h3>
                <div class="language-list">
                    <div class="language-item"><strong>Uppmärksam tid:</strong> Kvalitetstid tillsammans</div>
                    <div class="language-item"><strong>Tjänster:</strong> Hjälpsamma handlingar</div>
                    <div class="language-item"><strong>Gåvor:</strong> Fysiska presenter</div>
                    <div class="language-item"><strong>Beröring:</strong> Fysisk kontakt</div>
                    <div class="language-item"><strong>Uppmuntran:</strong> Beröm och uppskattning</div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="time-value">100</div>
                    <div class="stat-label">Tid</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="energy-value">80</div>
                    <div class="stat-label">Energi</div>
                </div>
                <div class="stat">
                    <div class="stat-value power-value" id="super-energy-value">50</div>
                    <div class="stat-label">Superenergi</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="day-value">1</div>
                    <div class="stat-label">Dag</div>
                </div>
                <div class="stat">
                    <div class="stat-value match-value" id="matches-value">0</div>
                    <div class="stat-label">Matchningar</div>
                </div>
                <div class="stat">
                    <div class="stat-value multiplayer-value" id="players-online">1</div>
                    <div class="stat-label">Spelare</div>
                </div>
            </div>
            
            <div id="special-event-container"></div>
            
            <div class="game-area">
                <div class="friends-panel">
                    <h2 class="panel-title">Dina Vänner</h2>
                    <div id="friends-container">
                        <!-- Vänner kommer att läggas till här med JavaScript -->
                    </div>
                </div>
                
                <div class="actions-panel">
                    <h2 class="panel-title">Möjliga Handlingar</h2>
                    <div id="actions-container">
                        <!-- Handlingsknappar kommer att läggas till här med JavaScript -->
                    </div>
                    
                    <div id="multiplayer-actions" style="margin-top: 20px;">
                        <h3 class="panel-title">Multiplayer Handlingar</h3>
                        <button id="help-player-btn" class="multiplayer-btn">Hjälp en spelare (+5 energi)</button>
                        <button id="share-super-btn" class="multiplayer-btn">Dela superenergi (+10 superenergi)</button>
                        <button id="team-power-btn" class="multiplayer-btn disabled" disabled>Team-kraft (kräver 2 spelare)</button>
                    </div>
                </div>
                
                <div class="powers-panel">
                    <h2 class="panel-title">Superkrafter</h2>
                    <div id="powers-container" class="powers-grid">
                        <!-- Superkrafter kommer att läggas till här med JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <h3 class="panel-title">Spelarchatt</h3>
                <div class="chat-messages" id="chat-messages">
                    <div class="log-entry system">Välkommen till chatten! Skriv för att kommunicera med andra spelare.</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Skriv ett meddelande..." maxlength="100">
                    <button id="send-chat-btn">Skicka</button>
                </div>
            </div>
            
            <div class="event-log">
                <h3 class="log-title">Spelhändelser</h3>
                <div id="log-container">
                    <div class="log-entry system">Välkommen till Friendships Multiplayer! Spela tillsammans för att bygga starka vänskaper.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mock WebSocket för demo (i en riktig app skulle detta vara en riktig WebSocket-anslutning) -->
    <script>
        // Mock WebSocket för demoändamål
        class MockWebSocket {
            constructor(url) {
                this.url = url;
                this.readyState = WebSocket.CONNECTING;
                this.onopen = null;
                this.onmessage = null;
                this.onclose = null;
                this.onerror = null;
                this.messages = [];
                
                // Simulera anslutning
                setTimeout(() => {
                    this.readyState = WebSocket.OPEN;
                    if (this.onopen) this.onopen({ type: 'open' });
                }, 500);
            }
            
            send(data) {
                this.messages.push(data);
                // Simulera svar från servern
                setTimeout(() => {
                    if (this.onmessage) {
                        const msg = JSON.parse(data);
                        let response;
                        
                        if (msg.type === 'createGame') {
                            response = {
                                type: 'gameCreated',
                                gameId: 'GAME' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                                players: [{ id: 'player1', name: 'Du', isHost: true }]
                            };
                        } else if (msg.type === 'joinGame') {
                            response = {
                                type: 'joinedGame',
                                gameId: msg.gameId,
                                playerId: 'player' + (Math.floor(Math.random() * 1000) + 2),
                                players: [
                                    { id: 'player1', name: 'Värd', isHost: true },
                                    { id: 'player' + (Math.floor(Math.random() * 1000) + 2), name: msg.playerName || 'Spelare', isHost: false }
                                ]
                            };
                        } else if (msg.type === 'playerAction') {
                            response = {
                                type: 'gameUpdate',
                                gameState: { /* skulle vara spelstatus här */ },
                                player: msg.player
                            };
                        } else if (msg.type === 'chatMessage') {
                            response = {
                                type: 'chatMessage',
                                player: msg.player,
                                message: msg.message,
                                timestamp: new Date().toISOString()
                            };
                        } else if (msg.type === 'multiplayerAction') {
                            response = {
                                type: 'multiplayerEffect',
                                action: msg.action,
                                fromPlayer: msg.player,
                                toPlayer: msg.toPlayer,
                                effect: msg.effect
                            };
                        }
                        
                        if (response) {
                            this.onmessage({ data: JSON.stringify(response) });
                        }
                    }
                }, 300);
            }
            
            close() {
                this.readyState = WebSocket.CLOSED;
                if (this.onclose) this.onclose({ type: 'close' });
            }
        }

        // Om vi inte har WebSocket (t.ex. i vissa testmiljöer), använd vår mock
        if (typeof WebSocket === 'undefined') {
            window.WebSocket = MockWebSocket;
        }
    </script>

    <script>
        // Game state med multiplayer-stöd
        let gameState = {
            // Multiplayer info
            gameId: null,
            playerId: null,
            playerName: 'Spelare',
            isHost: false,
            players: [],
            currentTurn: null,
            
            // Spelstatus
            time: 100,
            energy: 80,
            superEnergy: 50,
            day: 1,
            forgottenFriends: 0,
            successfulMatches: 0,
            
            // Vänskapssystem
            friendships: {},
            
            // Superkrafter
            powers: {},
            
            // Spelstatus
            activeFriend: null,
            specialEvent: null,
            hyperfocusActive: false,
            specialEventsActive: [],
            revealedLoveLanguages: {},
            empathyActive: false,
            
            // Multiplayer-cooldowns
            lastHelpGiven: 0,
            lastSuperShared: 0
        };

        // De fem kärleksspråken
        const LOVE_LANGUAGES = {
            'QUALITY_TIME': 'Uppmärksam tid',
            'ACTS_OF_SERVICE': 'Tjänster',
            'RECEIVING_GIFTS': 'Gåvor',
            'PHYSICAL_TOUCH': 'Beröring',
            'WORDS_OF_AFFIRMATION': 'Uppmuntran'
        };

        // Alla möjliga handlingar i spelet
        const actions = [
            { 
                id: 'chat', 
                name: 'Prata med vän', 
                time: 5, 
                energy: 10, 
                effect: 5,
                loveLanguages: ['QUALITY_TIME', 'WORDS_OF_AFFIRMATION'],
                description: 'Ett enkelt samtal'
            },
            { 
                id: 'activity', 
                name: 'Gör en aktivitet tillsammans', 
                time: 15, 
                energy: 20, 
                effect: 10,
                loveLanguages: ['QUALITY_TIME', 'PHYSICAL_TOUCH'],
                description: 'Gemensam aktivitet'
            },
            { 
                id: 'gift', 
                name: 'Ge en present', 
                time: 10, 
                energy: 5, 
                effect: 8,
                loveLanguages: ['RECEIVING_GIFTS'],
                description: 'En väl genomtänkt gåva'
            },
            { 
                id: 'help', 
                name: 'Hjälp med ett problem', 
                time: 20, 
                energy: 25, 
                effect: 15,
                loveLanguages: ['ACTS_OF_SERVICE'],
                description: 'Praktisk hjälp'
            },
            { 
                id: 'deep-talk', 
                name: 'Ha ett djupt samtal', 
                time: 25, 
                energy: 30, 
                effect: 20,
                loveLanguages: ['QUALITY_TIME', 'WORDS_OF_AFFIRMATION'],
                description: 'Djupt meningsfullt samtal'
            }
        ];

        // WebSocket anslutning
        let socket = null;
        let isConnected = false;

        // Initiera spelet
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeGameState();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Lobby-knappar
            document.getElementById('create-game-btn').addEventListener('click', createGame);
            document.getElementById('join-game-btn').addEventListener('click', joinGame);
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            document.getElementById('confirm-name-btn').addEventListener('click', confirmPlayerName);
            
            // Chat
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Multiplayer-knappar
            document.getElementById('help-player-btn').addEventListener('click', helpPlayer);
            document.getElementById('share-super-btn').addEventListener('click', shareSuperEnergy);
            document.getElementById('team-power-btn').addEventListener('click', useTeamPower);
        }

        // Skapa ett nytt spel
        function createGame() {
            const btn = document.getElementById('create-game-btn');
            btn.disabled = true;
            btn.textContent = 'Skapar spel...';
            
            // I en riktig app: Anslut till WebSocket server
            socket = new WebSocket('wss://example.com/game'); // Mock URL
            
            socket.onopen = function() {
                isConnected = true;
                socket.send(JSON.stringify({
                    type: 'createGame',
                    playerName: 'Värd'
                }));
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'gameCreated') {
                    gameState.gameId = data.gameId;
                    gameState.playerId = 'player1';
                    gameState.playerName = 'Värd';
                    gameState.isHost = true;
                    gameState.players = data.players;
                    
                    // Visa spelet skapat-sektion
                    document.getElementById('invite-code-display').textContent = data.gameId;
                    document.getElementById('game-created-section').style.display = 'block';
                    updatePlayersDisplay();
                } else if (data.type === 'playerJoined') {
                    gameState.players.push(data.player);
                    updatePlayersDisplay();
                    addChatMessage('system', `${data.player.name} har gått med i spelet!`);
                    
                    // Aktivera start-knappen om vi har minst 2 spelare
                    if (gameState.players.length >= 2) {
                        document.getElementById('start-game-btn').disabled = false;
                        document.getElementById('start-game-btn').classList.remove('disabled');
                    }
                } else if (data.type === 'gameStarted') {
                    startGameScreen();
                } else if (data.type === 'chatMessage') {
                    addChatMessage(data.player.name, data.message);
                } else if (data.type === 'gameUpdate') {
                    updateGameState(data.gameState);
                } else if (data.type === 'multiplayerEffect') {
                    handleMultiplayerEffect(data);
                }
            };
            
            socket.onclose = function() {
                isConnected = false;
                addLog('Anslutningen till servern bröts.', 'error');
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                // För demo: Simulera lyckad skapelse
                setTimeout(() => {
                    const gameId = 'GAME' + Math.random().toString(36).substr(2, 6).toUpperCase();
                    gameState.gameId = gameId;
                    gameState.playerId = 'player1';
                    gameState.playerName = 'Värd';
                    gameState.isHost = true;
                    gameState.players = [{ id: 'player1', name: 'Värd', isHost: true }];
                    
                    document.getElementById('invite-code-display').textContent = gameId;
                    document.getElementById('game-created-section').style.display = 'block';
                    updatePlayersDisplay();
                    
                    addLog(`Spel skapat! Dela koden: ${gameId}`, 'success');
                }, 1000);
            };
        }

        // Gå med i ett spel
        function joinGame() {
            const gameCode = document.getElementById('join-code-input').value.trim().toUpperCase();
            if (!gameCode) {
                document.getElementById('joining-status').textContent = 'Ange en giltig kod';
                return;
            }
            
            document.getElementById('join-game-btn').disabled = true;
            document.getElementById('joining-status').textContent = 'Ansluter...';
            
            // Visa namnval
            document.getElementById('player-name-section').style.display = 'block';
            
            // För demo: Simulera anslutning
            setTimeout(() => {
                document.getElementById('joining-status').textContent = 'Ansluten! Välj ditt namn ovan.';
            }, 1000);
        }

        // Bekräfta spelarnamn
        function confirmPlayerName() {
            const playerName = document.getElementById('player-name-input').value.trim() || 'Spelare';
            gameState.playerName = playerName;
            
            // I en riktig app: Skicka namn till servern
            if (socket && isConnected) {
                socket.send(JSON.stringify({
                    type: 'joinGame',
                    gameId: document.getElementById('join-code-input').value.trim().toUpperCase(),
                    playerName: playerName
                }));
            } else {
                // Demo: Simulera att vi gått med
                const gameCode = document.getElementById('join-code-input').value.trim().toUpperCase();
                if (!gameCode) {
                    addLog('Ange en spelkod först', 'error');
                    return;
                }
                
                gameState.gameId = gameCode;
                gameState.playerId = 'player' + (Math.floor(Math.random() * 1000) + 2);
                gameState.isHost = false;
                gameState.players = [
                    { id: 'player1', name: 'Värd', isHost: true },
                    { id: gameState.playerId, name: playerName, isHost: false }
                ];
                
                // Gå direkt till spelet i demo
                startGameScreen();
                addLog(`Du gick med i spelet ${gameCode} som ${playerName}`, 'success');
                addChatMessage('system', `${playerName} har gått med i spelet!`);
            }
        }

        // Starta spelet (endast värd)
        function startGame() {
            if (!gameState.isHost) return;
            
            if (socket && isConnected) {
                socket.send(JSON.stringify({
                    type: 'startGame',
                    gameId: gameState.gameId
                }));
            } else {
                // Demo: Starta spelet direkt
                startGameScreen();
                addLog('Spelet har startat!', 'success');
                
                // Lägg till demo-spelare
                const demoPlayers = ['Anna', 'Erik', 'Sofia'];
                demoPlayers.forEach(name => {
                    if (gameState.players.length < 4) {
                        const playerId = 'player' + (gameState.players.length + 1);
                        gameState.players.push({ 
                            id: playerId, 
                            name: name, 
                            isHost: false,
                            time: 100,
                            energy: 80,
                            superEnergy: 50
                        });
                    }
                });
                updatePlayersDisplay();
            }
        }

        // Visa spelgränssnittet
        function startGameScreen() {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            initializeGameState();
            renderFriends();
            renderActions();
            renderPowers();
            updateStats();
            updatePlayersDisplay();
            
            // Starta speluppdateringar
            setInterval(updateCooldowns, 1000);
            setInterval(checkForSpecialEvent, 30000);
        }

        // Initiera spelstatus
        function initializeGameState() {
            // Återställ vänskapssystem
            gameState.friendships = {
                'Alex': { 
                    level: 20, 
                    personality: 'aktiv', 
                    trait: 'sportig',
                    loveLanguage: 'QUALITY_TIME',
                    lastInteracted: 0,
                    forgottenLevel: 0
                },
                'Sara': { 
                    level: 15, 
                    personality: 'kreativ', 
                    trait: 'konstnärlig',
                    loveLanguage: 'RECEIVING_GIFTS',
                    lastInteracted: 0,
                    forgottenLevel: 0
                },
                'Marcus': { 
                    level: 10, 
                    personality: 'blyg', 
                    trait: 'introvert',
                    loveLanguage: 'WORDS_OF_AFFIRMATION',
                    lastInteracted: 0,
                    forgottenLevel: 0
                },
                'Emma': { 
                    level: 5, 
                    personality: 'social', 
                    trait: 'extrovert',
                    loveLanguage: 'PHYSICAL_TOUCH',
                    lastInteracted: 0,
                    forgottenLevel: 0
                },
                'David': { 
                    level: 0, 
                    personality: 'intellektuell', 
                    trait: 'filosofisk',
                    loveLanguage: 'ACTS_OF_SERVICE',
                    lastInteracted: 0,
                    forgottenLevel: 0
                }
            };
            
            // Återställ superkrafter
            gameState.powers = {
                'empati': { 
                    name: 'Empatiblast', 
                    cooldown: 0, 
                    maxCooldown: 3, 
                    cost: 15, 
                    effect: 'Ökar vänskap med alla vänner med 5%'
                },
                'tid': { 
                    name: 'Tidsfrysning', 
                    cooldown: 0, 
                    maxCooldown: 5, 
                    cost: 20, 
                    effect: 'Återställer tid till 100'
                },
                'recall': { 
                    name: 'Återkallelse', 
                    cooldown: 0, 
                    maxCooldown: 6, 
                    cost: 25, 
                    effect: 'Återställer en glömd vänskap'
                },
                'energi': { 
                    name: 'Energiboost', 
                    cooldown: 0, 
                    maxCooldown: 4, 
                    cost: 15, 
                    effect: 'Återställer energi till 80'
                },
                'fokus': { 
                    name: 'Hyperfokus', 
                    cooldown: 0, 
                    maxCooldown: 3, 
                    cost: 10, 
                    effect: 'Dubblar nästa handling'
                },
                'glädje': { 
                    name: 'Glädjespridning', 
                    cooldown: 0, 
                    maxCooldown: 4, 
                    cost: 12, 
                    effect: 'Ökar slumpmässig vänskap'
                }
            };
            
            // Återställ övrigt
            gameState.time = 100;
            gameState.energy = 80;
            gameState.superEnergy = 50;
            gameState.day = 1;
            gameState.forgottenFriends = 0;
            gameState.successfulMatches = 0;
            gameState.activeFriend = null;
            gameState.specialEvent = null;
            gameState.hyperfocusActive = false;
            gameState.specialEventsActive = [];
            gameState.revealedLoveLanguages = {};
            gameState.empathyActive = false;
            gameState.lastHelpGiven = 0;
            gameState.lastSuperShared = 0;
            
            // Sätt första spelarens tur
            if (gameState.players.length > 0) {
                gameState.currentTurn = gameState.players[0].id;
            }
        }

        // Uppdatera spelardisplay
        function updatePlayersDisplay() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            
            document.getElementById('players-online').textContent = gameState.players.length;
            
            gameState.players.forEach(player => {
                const isYou = player.id === gameState.playerId;
                const isActive = player.id === gameState.currentTurn;
                
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${isYou ? 'you' : ''} ${isActive ? 'active' : ''}`;
                
                const playerName = document.createElement('div');
                playerName.className = `player-name ${isYou ? 'you' : ''}`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.name + (player.isHost ? ' (Värd)' : '');
                
                const badges = document.createElement('div');
                if (isYou) {
                    badges.innerHTML = `<span class="you-badge">Du</span>`;
                }
                if (isActive) {
                    badges.innerHTML += `<span class="turn-indicator">TUR</span>`;
                }
                
                playerName.appendChild(nameSpan);
                playerName.appendChild(badges);
                
                // Spelarstatistik
                const stats = document.createElement('div');
                stats.className = 'player-status';
                stats.innerHTML = `
                    <div style="margin-top: 10px;">
                        <div>Tid: <strong>${player.time || 100}</strong></div>
                        <div>Energi: <strong>${player.energy || 80}</strong></div>
                        <div>Superenergi: <strong>${player.superEnergy || 50}</strong></div>
                    </div>
                `;
                
                playerCard.appendChild(playerName);
                playerCard.appendChild(stats);
                container.appendChild(playerCard);
            });
            
            // Uppdatera team-kraft knapp
            const teamPowerBtn = document.getElementById('team-power-btn');
            if (gameState.players.length >= 2) {
                teamPowerBtn.disabled = false;
                teamPowerBtn.classList.remove('disabled');
            }
        }

        // Rendera vänner (samma som tidigare men med multiplayer-färger)
        function renderFriends() {
            const container = document.getElementById('friends-container');
            container.innerHTML = '';
            
            for (const [name, data] of Object.entries(gameState.friendships)) {
                const friendElement = document.createElement('div');
                friendElement.className = 'friend';
                friendElement.setAttribute('data-name', name);
                
                if (data.forgottenLevel > 0) {
                    friendElement.classList.add(`level-${data.forgottenLevel}`);
                }
                
                if (gameState.activeFriend === name) {
                    friendElement.style.borderLeftColor = '#4a6fa5';
                } else if (data.forgottenLevel > 0) {
                    friendElement.style.borderLeftColor = data.forgottenLevel === 1 ? '#e67e22' : 
                                                        data.forgottenLevel === 2 ? '#e67e22' : '#e74c3c';
                }
                
                const level = data.level;
                const personality = data.personality;
                const trait = data.trait;
                const levelText = getFriendshipLevelText(level);
                const daysSince = data.lastInteracted;
                
                // Färg för friendships-mätaren baserat på nivå
                let friendshipColor = '#4a6fa5'; // Blå
                if (level >= 80) friendshipColor = '#2ecc71'; // Grön för bästa vänner
                else if (level >= 60) friendshipColor = '#3498db'; // Ljusblå för nära vänner
                
                const knowsLoveLanguage = gameState.revealedLoveLanguages[name] || 
                                         gameState.empathyActive || 
                                         level >= 30;
                
                let loveLanguageDisplay = '';
                if (knowsLoveLanguage) {
                    const languageName = LOVE_LANGUAGES[data.loveLanguage];
                    loveLanguageDisplay = `<span class="love-language" data-language="${data.loveLanguage}">${languageName}</span>`;
                } else {
                    loveLanguageDisplay = `<span class="love-language" style="background-color: #95a5a6; color: #7f8c8d;">???</span>`;
                }
                
                let forgetfulnessBadge = '';
                if (data.forgottenLevel > 0) {
                    const badgeText = data.forgottenLevel === 1 ? 'Lite glömd' : 
                                    data.forgottenLevel === 2 ? 'Börjar glömma' : 'Nästan glömd';
                    forgetfulnessBadge = `<span class="forgotten-badge">${badgeText}</span>`;
                }
                
                friendElement.innerHTML = `
                    <h3 class="friend-name">${name} ${loveLanguageDisplay}${forgetfulnessBadge}</h3>
                    <div class="friendship-level">${levelText} (${level}%) - ${personality} (${trait})</div>
                    <div class="friendship-level" style="font-size: 12px; color: ${daysSince > 2 ? '#e74c3c' : '#666'}">
                        ${daysSince === 0 ? 'Interagerad idag' : `Ej interagerat på ${daysSince} dagar`}
                    </div>
                    <div class="friendship-meter">
                        <div class="friendship-fill" style="width: ${level}%; background-color: ${friendshipColor}"></div>
                    </div>
                `;
                
                friendElement.addEventListener('click', function() {
                    if (gameState.currentTurn === gameState.playerId) {
                        selectFriend(name);
                    } else {
                        addLog(`Det är inte din tur att spela. Vänta på ${gameState.players.find(p => p.id === gameState.currentTurn)?.name || 'andra spelaren'}.`, 'warning');
                    }
                });
                
                container.appendChild(friendElement);
            }
        }

        // Rendera handlingar (uppdaterad för tur-baserat spel)
        function renderActions() {
            const container = document.getElementById('actions-container');
            container.innerHTML = '';
            
            const isMyTurn = gameState.currentTurn === gameState.playerId;
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'action-btn';
                button.id = `action-${action.id}`;
                
                // Disable om inte din tur
                if (!isMyTurn) {
                    button.disabled = true;
                }
                
                // Kolla matchning
                let isMatching = false;
                let bonusText = '';
                
                if (gameState.activeFriend && isMyTurn) {
                    const friend = gameState.friendships[gameState.activeFriend];
                    const knowsLoveLanguage = gameState.revealedLoveLanguages[gameState.activeFriend] || 
                                             gameState.empathyActive || 
                                             friend.level >= 30;
                    
                    if (knowsLoveLanguage) {
                        isMatching = action.loveLanguages.includes(friend.loveLanguage);
                        if (isMatching) {
                            button.classList.add('matching');
                            bonusText = `<span class="matching-bonus">Matchar!</span>`;
                        }
                    }
                }
                
                button.innerHTML = `${action.name} ${bonusText}`;
                button.disabled = !isMyTurn || gameState.activeFriend === null;
                
                const costInfo = document.createElement('div');
                costInfo.className = 'action-cost';
                costInfo.innerHTML = `${action.description}<br>Kostar: ${action.time} tid, ${action.energy} energi`;
                
                if (isMyTurn) {
                    button.addEventListener('click', function() {
                        performAction(action);
                    });
                }
                
                container.appendChild(button);
                container.appendChild(costInfo);
            });
        }

        // Rendera superkrafter
        function renderPowers() {
            const container = document.getElementById('powers-container');
            container.innerHTML = '';
            
            const isMyTurn = gameState.currentTurn === gameState.playerId;
            
            for (const [powerId, power] of Object.entries(gameState.powers)) {
                const button = document.createElement('button');
                button.className = 'power-btn';
                button.id = `power-${powerId}`;
                button.textContent = power.name;
                button.disabled = !isMyTurn || gameState.superEnergy < power.cost || power.cooldown > 0;
                
                const costInfo = document.createElement('div');
                costInfo.className = 'power-cost';
                costInfo.innerHTML = `Kostar: ${power.cost} superenergi<br>Effekt: ${power.effect}`;
                
                const cooldownInfo = document.createElement('div');
                cooldownInfo.className = 'power-cooldown';
                cooldownInfo.id = `cooldown-${powerId}`;
                if (power.cooldown > 0) {
                    cooldownInfo.textContent = `Cooldown: ${power.cooldown} dag(ar)`;
                } else {
                    cooldownInfo.style.display = 'none';
                }
                
                if (isMyTurn) {
                    button.addEventListener('click', function() {
                        usePower(powerId);
                    });
                }
                
                container.appendChild(button);
                container.appendChild(costInfo);
                container.appendChild(cooldownInfo);
            }
        }

        // Välj vän
        function selectFriend(friendName) {
            gameState.activeFriend = friendName;
            renderFriends();
            renderActions();
            addLog(`Du valde att interagera med ${friendName}.`, 'info');
        }

        // Utför handling
        function performAction(action) {
            if (!gameState.activeFriend || gameState.currentTurn !== gameState.playerId) return;
            
            if (gameState.time < action.time) {
                addLog(`Du har inte tillräckligt med tid.`, 'error');
                return;
            }
            
            if (gameState.energy < action.energy) {
                addLog(`Du har inte tillräckligt med energi.`, 'error');
                return;
            }
            
            // Dra av resurser
            gameState.time -= action.time;
            gameState.energy -= action.energy;
            
            // Kolla matchning
            const friend = gameState.friendships[gameState.activeFriend];
            const knowsLoveLanguage = gameState.revealedLoveLanguages[gameState.activeFriend] || 
                                     gameState.empathyActive || 
                                     friend.level >= 30;
            
            let isMatching = false;
            let bonusEffect = 0;
            let matchMessage = '';
            
            if (knowsLoveLanguage) {
                isMatching = action.loveLanguages.includes(friend.loveLanguage);
                
                if (isMatching) {
                    bonusEffect = Math.ceil(action.effect * 0.5);
                    matchMessage = ` Matchade ${gameState.activeFriend}s kärleksspråk!`;
                    gameState.successfulMatches++;
                    
                    if (!gameState.revealedLoveLanguages[gameState.activeFriend]) {
                        gameState.revealedLoveLanguages[gameState.activeFriend] = true;
                    }
                }
            }
            
            // Beräkna effekt
            let effect = action.effect + bonusEffect;
            
            if (friend.forgottenLevel > 0) {
                const reconnectionBonus = friend.forgottenLevel * 3;
                effect += reconnectionBonus;
                addLog(`${gameState.activeFriend} var glad att höra från dig igen!`, 'success');
            }
            
            if (gameState.hyperfocusActive) {
                effect = effect * 2;
                gameState.hyperfocusActive = false;
                addLog(`Hyperfokus effekten användes!`, 'success');
            }
            
            // Uppdatera vänskap
            friend.lastInteracted = 0;
            friend.forgottenLevel = 0;
            const oldLevel = friend.level;
            friend.level = Math.min(100, friend.level + effect);
            
            // Ge superenergi
            let superEnergyGain = Math.floor(effect / 3);
            if (isMatching) superEnergyGain += 3;
            gameState.superEnergy = Math.min(100, gameState.superEnergy + superEnergyGain);
            
            addLog(`Du ${action.name.toLowerCase()} med ${gameState.activeFriend}.${matchMessage} Vänskapsnivån: ${oldLevel}% → ${friend.level}%. Superenergi: +${superEnergyGain}`, 'success');
            
            // Skicka till andra spelare
            if (socket && isConnected) {
                socket.send(JSON.stringify({
                    type: 'playerAction',
                    player: gameState.playerId,
                    action: action.id,
                    friend: gameState.activeFriend,
                    effect: effect
                }));
            }
            
            // Kolla om dagens slut
            if (gameState.time <= 0 || gameState.energy <= 0) {
                endTurn();
            } else {
                updateStats();
                renderFriends();
                renderActions();
                renderPowers();
            }
            
            checkWinCondition();
        }

        // Använd superkraft
        function usePower(powerId) {
            if (gameState.currentTurn !== gameState.playerId) return;
            
            const power = gameState.powers[powerId];
            
            if (power.cooldown > 0) {
                addLog(`${power.name} är inte redo än.`, 'error');
                return;
            }
            
            if (gameState.superEnergy < power.cost) {
                addLog(`Du har inte tillräckligt med superenergi.`, 'error');
                return;
            }
            
            gameState.superEnergy -= power.cost;
            power.cooldown = power.maxCooldown;
            
            let powerMessage = '';
            
            switch(powerId) {
                case 'empati':
                    Object.values(gameState.friendships).forEach(data => {
                        data.level = Math.min(100, data.level + 5);
                        if (data.forgottenLevel > 0) {
                            data.forgottenLevel = Math.max(0, data.forgottenLevel - 1);
                        }
                    });
                    powerMessage = "Empatiblast ökade alla vänskaper med 5%!";
                    break;
                    
                case 'tid':
                    gameState.time = 100;
                    powerMessage = "Tiden frös! Du fick tillbaka all tid.";
                    break;
                    
                case 'recall':
                    const forgottenFriends = Object.entries(gameState.friendships)
                        .filter(([name, data]) => data.forgottenLevel >= 2 && data.level < 20);
                    
                    if (forgottenFriends.length > 0) {
                        const [name, data] = forgottenFriends[Math.floor(Math.random() * forgottenFriends.length)];
                        const oldLevel = data.level;
                        data.level = 20;
                        data.lastInteracted = 0;
                        data.forgottenLevel = 0;
                        powerMessage = `Återkallelse väckte minnen hos ${name}! (${oldLevel}% → 20%)`;
                    } else {
                        powerMessage = "Inga vänner är tillräckligt glömda.";
                    }
                    break;
                    
                case 'energi':
                    gameState.energy = 80;
                    powerMessage = "Energiboost laddade upp dig!";
                    break;
                    
                case 'fokus':
                    gameState.hyperfocusActive = true;
                    powerMessage = "Hyperfokus aktiverat!";
                    break;
                    
                case 'glädje':
                    const friends = Object.keys(gameState.friendships);
                    const randomFriend = friends[Math.floor(Math.random() * friends.length)];
                    const oldLevel = gameState.friendships[randomFriend].level;
                    gameState.friendships[randomFriend].level = Math.min(100, oldLevel + 15);
                    gameState.friendships[randomFriend].forgottenLevel = Math.max(0, gameState.friendships[randomFriend].forgottenLevel - 1);
                    powerMessage = `Glädjespridning träffade ${randomFriend}! (${oldLevel}% → ${gameState.friendships[randomFriend].level}%)`;
                    break;
            }
            
            addLog(`Du använde ${power.name}! ${powerMessage}`, 'success');
            
            // Skicka till andra spelare
            if (socket && isConnected) {
                socket.send(JSON.stringify({
                    type: 'playerAction',
                    player: gameState.playerId,
                    action: 'power',
                    power: powerId,
                    effect: powerMessage
                }));
            }
            
            updateStats();
            renderFriends();
            renderActions();
            renderPowers();
        }

        // Hjälp en annan spelare
        function helpPlayer() {
            if (gameState.currentTurn !== gameState.playerId) return;
            
            if (gameState.energy < 15) {
                addLog(`Du behöver minst 15 energi för att hjälpa andra.`, 'error');
                return;
            }
            
            if (gameState.day - gameState.lastHelpGiven < 2) {
                addLog(`Du kan bara hjälpa en spelare varannan dag.`, 'warning');
                return;
            }
            
            // Välj en slumpmässig spelare (förutom dig själv)
            const otherPlayers = gameState.players.filter(p => p.id !== gameState.playerId);
            if (otherPlayers.length === 0) {
                addLog(`Det finns ingen annan spelare att hjälpa.`, 'warning');
                return;
            }
            
            const targetPlayer = otherPlayers[Math.floor(Math.random() * otherPlayers.length)];
            
            // Dra av energi och uppdatera cooldown
            gameState.energy -= 15;
            gameState.lastHelpGiven = gameState.day;
            
            // Ge mottagaren energi
            targetPlayer.energy = Math.min(100, (targetPlayer.energy || 80) + 5);
            
            addLog(`Du hjälpte ${targetPlayer.name}! De fick +5 energi.`, 'success');
            addChatMessage('system', `${gameState.playerName} hjälpte ${targetPlayer.name} med extra energi!`);
            
            // Skicka till andra spelare
            if (socket && isConnected) {
                socket.send(JSON.stringify({
                    type: 'multiplayerAction',
                    player: gameState.playerId,
                    action: 'help',
                    toPlayer: targetPlayer.id,
                    effect: '+5 energi'
                }));
            }
            
            updateStats();
            updatePlayersDisplay();
            renderActions();
        }

        // Dela superenergi
        function shareSuperEnergy() {
            if (gameState.currentTurn !== gameState.playerId) return;
            
            if (gameState.superEnergy < 20) {
                addLog(`Du behöver minst 20 superenergi för att dela.`, 'error');
                return;
            }
            
            if (gameState.day - gameState.lastSuperShared < 3) {
                addLog(`Du kan bara dela superenergi var tredje dag.`, 'warning');
                return;
            }
            
            const otherPlayers = gameState.players.filter(p => p.id !== gameState.playerId);
            if (otherPlayers.length === 0) {
                addLog(`Det finns ingen annan spelare att dela med.`, 'warning');
                return;
            }
            
            const targetPlayer = otherPlayers[Math.floor(Math.random() * otherPlayers.length)];
            
            gameState.superEnergy -= 20;
            gameState.lastSuperShared = gameState.day;
            
            targetPlayer.superEnergy = Math.min(100, (targetPlayer.superEnergy || 50) + 10);
            
            addLog(`Du delade superenergi med ${targetPlayer.name}! De fick +10 superenergi.`, 'success');
            addChatMessage('system', `${gameState.playerName} delade superenergi med ${targetPlayer.name}!`);
            
            if (socket && isConnected) {
                socket.send(JSON.stringify({
                    type: 'multiplayerAction',
                    player: gameState.playerId,
                    action: 'shareSuper',
                    toPlayer: targetPlayer.id,
                    effect: '+10 superenergi'
                }));
            }
            
            updateStats();
            updatePlayersDisplay();
            renderPowers();
        }

        // Använd team-kraft
        function useTeamPower() {
            if (gameState.currentTurn !== gameState.playerId) return;
            
            if (gameState.players.length < 2) {
                addLog(`Team-krafter kräver minst 2 spelare.`, 'warning');
                return;
            }
            
            if (gameState.superEnergy < 30) {
                addLog(`Du behöver minst 30 superenergi för team-kraft.`, 'error');
                return;
            }
            
            // Dra av superenergi
            gameState.superEnergy -= 30;
            
            // Positiv effekt för alla spelare
            gameState.players.forEach(player => {
                if (player.id === gameState.playerId) {
                    // Du får lite mer
                    player.energy = Math.min(100, (player.energy || 80) + 10);
                    player.superEnergy = Math.min(100, (player.superEnergy || 50) + 5);
                } else {
                    player.energy = Math.min(100, (player.energy || 80) + 5);
                    player.superEnergy = Math.min(100, (player.superEnergy || 50) + 3);
                }
            });
            
            // Positiv effekt för alla vänskaper
            Object.values(gameState.friendships).forEach(data => {
                data.level = Math.min(100, data.level + 3);
            });
            
            addLog(`Team-kraft aktiverad! Alla spelare fick extra resurser och alla vänskaper ökade med 3%!`, 'success');
            addChatMessage('system', `${gameState.playerName} aktiverade en team-kraft! Alla fick bonus!`);
            
            if (socket && isConnected) {
                socket.send(JSON.stringify({
                    type: 'multiplayerAction',
                    player: gameState.playerId,
                    action: 'teamPower',
                    effect: 'Alla fick bonus!'
                }));
            }
            
            updateStats();
            updatePlayersDisplay();
            renderFriends();
            renderPowers();
        }

        // Hantera multiplayer-effekter från andra spelare
        function handleMultiplayerEffect(data) {
            if (data.toPlayer === gameState.playerId) {
                // Effekten är riktad till dig
                switch(data.action) {
                    case 'help':
                        gameState.energy = Math.min(100, gameState.energy + 5);
                        addLog(`${data.fromPlayer} hjälpte dig! Du fick +5 energi.`, 'success');
                        break;
                    case 'shareSuper':
                        gameState.superEnergy = Math.min(100, gameState.superEnergy + 10);
                        addLog(`${data.fromPlayer} delade superenergi med dig! Du fick +10 superenergi.`, 'success');
                        break;
                }
            }
            
            if (data.action === 'teamPower') {
                // Team-effekt
                gameState.energy = Math.min(100, gameState.energy + 5);
                gameState.superEnergy = Math.min(100, gameState.superEnergy + 3);
                Object.values(gameState.friendships).forEach(data => {
                    data.level = Math.min(100, data.level + 3);
                });
                addLog(`Team-kraft från ${data.fromPlayer}! Alla fick bonus.`, 'success');
            }
            
            updateStats();
            renderFriends();
        }

        // Avsluta tur
        function endTurn() {
            // Avsluta dagen för den här spelaren
            gameState.day++;
            gameState.time = 100;
            gameState.energy = 80;
            
            // Glömska för vänner
            Object.values(gameState.friendships).forEach(data => {
                if (gameState.activeFriend && data !== gameState.friendships[gameState.activeFriend]) {
                    data.lastInteracted++;
                    
                    const daysSince = data.lastInteracted;
                    if (daysSince > 10) data.level = Math.max(0, data.level - 8);
                    else if (daysSince > 5) data.level = Math.max(0, data.level - 5);
                    else if (daysSince > 2) data.level = Math.max(0, data.level - 3);
                    else if (daysSince > 0) data.level = Math.max(0, data.level - 2);
                    
                    // Uppdatera glömska-nivå
                    if (daysSince > 10) data.forgottenLevel = 3;
                    else if (daysSince > 5) data.forgottenLevel = 2;
                    else if (daysSince > 2) data.forgottenLevel = 1;
                    else data.forgottenLevel = 0;
                }
            });
            
            gameState.activeFriend = null;
            gameState.hyperfocusActive = false;
            
            // Nästa spelares tur
            const currentIndex = gameState.players.findIndex(p => p.id === gameState.currentTurn);
            const nextIndex = (currentIndex + 1) % gameState.players.length;
            gameState.currentTurn = gameState.players[nextIndex].id;
            
            addLog(`Din dag är slut. ${gameState.players[nextIndex].name}s tur börjar.`, 'info');
            
            updateStats();
            updatePlayersDisplay();
            renderFriends();
            renderActions();
            renderPowers();
        }

        // Uppdatera cooldowns
        function updateCooldowns() {
            Object.values(gameState.powers).forEach(power => {
                const cooldownElement = document.getElementById(`cooldown-${Object.keys(gameState.powers).find(k => gameState.powers[k] === power)}`);
                if (cooldownElement) {
                    if (power.cooldown > 0) {
                        cooldownElement.textContent = `Cooldown: ${power.cooldown} dag(ar)`;
                        cooldownElement.style.display = 'block';
                    } else {
                        cooldownElement.style.display = 'none';
                    }
                }
            });
        }

        // Specialhändelser
        function checkForSpecialEvent() {
            if (Math.random() < 0.15 && !gameState.specialEvent) {
                const events = [
                    { title: "Vänskapsvecka", description: "Alla vänskapsförluster halveras!", effect: "halfLoss", duration: 60000 },
                    { title: "Superenergiflöde", description: "Alla spelare får 15 superenergi!", effect: "extraSuperEnergy", duration: 0 },
                    { title: "Samarbetsdag", description: "Multiplayer-åtgärder ger dubbel effekt!", effect: "doubleMultiplayer", duration: 60000 }
                ];
                
                const event = events[Math.floor(Math.random() * events.length)];
                gameState.specialEvent = event;
                
                if (event.effect === 'extraSuperEnergy') {
                    gameState.players.forEach(player => {
                        player.superEnergy = Math.min(100, (player.superEnergy || 50) + 15);
                    });
                    addLog(`Specialhändelse: ${event.description}`, 'success');
                    addChatMessage('system', `Specialhändelse: ${event.title}! Alla fick superenergi!`);
                    updatePlayersDisplay();
                } else {
                    showSpecialEvent(event);
                    setTimeout(() => {
                        gameState.specialEvent = null;
                        addLog(`${event.title} är nu över.`, 'info');
                    }, event.duration);
                }
            }
        }

        function showSpecialEvent(event) {
            const container = document.getElementById('special-event-container');
            container.innerHTML = `<div class="special-event"><h3>${event.title}</h3><p>${event.description}</p></div>`;
            addLog(`Specialhändelse: ${event.title} - ${event.description}`, 'success');
        }

        // Uppdatera statistik
        function updateStats() {
            document.getElementById('time-value').textContent = gameState.time;
            document.getElementById('energy-value').textContent = gameState.energy;
            document.getElementById('super-energy-value').textContent = gameState.superEnergy;
            document.getElementById('day-value').textContent = gameState.day;
            document.getElementById('matches-value').textContent = gameState.successfulMatches;
            
            // Uppdatera multiplayer-knappar
            const isMyTurn = gameState.currentTurn === gameState.playerId;
            document.getElementById('help-player-btn').disabled = !isMyTurn || gameState.energy < 15 || (gameState.day - gameState.lastHelpGiven < 2);
            document.getElementById('share-super-btn').disabled = !isMyTurn || gameState.superEnergy < 20 || (gameState.day - gameState.lastSuperShared < 3);
            document.getElementById('team-power-btn').disabled = !isMyTurn || gameState.superEnergy < 30 || gameState.players.length < 2;
        }

        // Lägg till loggmeddelande
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`;
            logEntry.textContent = `Dag ${gameState.day}: ${message}`;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            while (logContainer.children.length > 15) {
                logContainer.removeChild(logContainer.lastChild);
            }
            logContainer.scrollTop = 0;
        }

        // Lägg till chattmeddelande
        function addChatMessage(sender, message) {
            const chatContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = `log-entry ${sender === 'system' ? 'system' : sender === gameState.playerName ? 'you' : 'player'}`;
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Skicka chattmeddelande
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message && socket && isConnected) {
                socket.send(JSON.stringify({
                    type: 'chatMessage',
                    player: gameState.playerId,
                    message: message
                }));
                input.value = '';
            } else if (message) {
                // Demo: Lägg till meddelande lokalt
                addChatMessage(gameState.playerName, message);
                input.value = '';
            }
        }

        // Hjälpfunktioner
        function getFriendshipLevelText(level) {
            if (level >= 90) return 'Bästa vän för livet';
            if (level >= 80) return 'Bästa vän';
            if (level >= 60) return 'Nära vän';
            if (level >= 40) return 'Vän';
            if (level >= 20) return 'Bekant';
            if (level > 0) return 'Ny bekantskap';
            return 'Främling';
        }

        // Kolla vinstvillkor (team-baserat)
        function checkWinCondition() {
            let totalFriendships = 0;
            let closeFriends = 0;
            
            Object.values(gameState.friendships).forEach(data => {
                totalFriendships += data.level;
                if (data.level >= 60) closeFriends++;
            });
            
            const averageFriendship = totalFriendships / Object.keys(gameState.friendships).length;
            
            // Team-vinst: Genomsnittlig vänskap över 60% och minst 3 nära vänner
            if (averageFriendship >= 60 && closeFriends >= 3) {
                addLog('GRATTIS! Ert team har byggt starka vänskaper tillsammans!', 'success');
                endGame(true);
            }
        }

        // Avsluta spelet
        function endGame(teamWin) {
            let message = teamWin 
                ? `🎊 TEAM-VINST! 🎊\n\nGrattis till alla spelare! Ni har tillsammans byggt fantastiska vänskaper.\n\nGenomsnittlig vänskapsnivå: ${Math.round(Object.values(gameState.friendships).reduce((a, b) => a + b.level, 0) / Object.keys(gameState.friendships).length)}%\n\nArbeta tillsammans gör vänskap starkare!`
                : `Spelet är slut! Ni var nära att vinna som team.\n\nFortsätt samarbeta för att bygga ännu starkare vänskaper!`;
            
            // Disable alla knappar
            document.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            setTimeout(() => {
                alert(message);
            }, 1000);
        }
    </script>
</body>
</html>